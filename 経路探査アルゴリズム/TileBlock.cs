using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace 経路探査アルゴリズム
{
    class TileBlock
    {
        ////////////////////////////////////////////////////////////////////////
        // タイル属性を示すEnum
        ////////////////////////////////////////////////////////////////////////
        public enum TileType : int
        {
            Walkable = 1,
            Wall = 2,
            StartTile = 3,
            GoalTile = 4,
            NullTile = 5,
            AnalyzedTile = 6
        }

        ////////////////////////////////////////////////////////////////////////
        // 探索に使用する属性を示すEnum
        ////////////////////////////////////////////////////////////////////////
        public enum AnalyzeAttributes : int
        {
            INull = 0x00000000,
            IOpenedTile = 0x00000030,
            IClosedTile = 0x00000040,
        }

        ////////////////////////////////////////////////////////////////////////
        // 探索データ構造体
        ////////////////////////////////////////////////////////////////////////
        public struct AnalyzeData
        {
            public int コスト;
            public int 推定コスト;
            public int スコア;
        }

        ////////////////////////////////////////////////////////////////////////
        // タイル構造体
        ////////////////////////////////////////////////////////////////////////
        private struct TileStruct
        {
            public Vector2 coordinate;
            public TileType tileType;
            public AnalyzeAttributes attributes;
            public AnalyzeData analyzeData;
            public bool isAnalyzed;
        }

        private TileStruct tile;

        ////////////////////////////////////////////////////////////////////////
        // コンストラクタ
        ////////////////////////////////////////////////////////////////////////
        public TileBlock(Vector2 coord, TileType type)
        {
            tile = new TileStruct();
            tile.coordinate = coord;
            tile.tileType = type;
            tile.attributes = AnalyzeAttributes.INull;
            tile.isAnalyzed = false;
        }

        ////////////////////////////////////////////////////////////////////////
        // 座標を取得
        ////////////////////////////////////////////////////////////////////////
        public Vector2 GetCoordinate()
        {
            return this.tile.coordinate;
        }

        ////////////////////////////////////////////////////////////////////////
        // 上のブロックの座標を取得
        ////////////////////////////////////////////////////////////////////////
        public Vector2 GetTopCoord()
        {
            return new Vector2(tile.coordinate.x, tile.coordinate.y - 1);
        }

        ////////////////////////////////////////////////////////////////////////
        // 下のブロックの座標を取得
        ////////////////////////////////////////////////////////////////////////
        public Vector2 GetBottomCoord()
        {
            return new Vector2(tile.coordinate.x, tile.coordinate.y + 1);
        }

        ////////////////////////////////////////////////////////////////////////
        // 右のブロックの座標を取得
        ////////////////////////////////////////////////////////////////////////
        public Vector2 GetRightCoord()
        {
            return new Vector2(tile.coordinate.x + 1, tile.coordinate.y);
        }

        ////////////////////////////////////////////////////////////////////////
        // 左のブロックの座標を取得
        ////////////////////////////////////////////////////////////////////////
        public Vector2 GetLeftCoord()
        {
            return new Vector2(tile.coordinate.x - 1, tile.coordinate.y);
        }

        ////////////////////////////////////////////////////////////////////////
        // タイル属性を取得
        ////////////////////////////////////////////////////////////////////////
        public TileType GetTileType()
        {
            return tile.tileType;
        }

        ////////////////////////////////////////////////////////////////////////
        // タイル属性を設定
        ////////////////////////////////////////////////////////////////////////
        public void SetTileType(TileType type)
        {
            tile.tileType = type;
        }

        ////////////////////////////////////////////////////////////////////////
        // オーバーロード
        // typeがTileTypeの範囲を超えた場合InvaildCastExceptionが発生することを考慮
        ////////////////////////////////////////////////////////////////////////
        public void SetTileType(int type)
        {
            try
            {
                tile.tileType = (TileType)type;
            }
            catch(InvalidCastException ex)
            {
                LoggerForm.WriteError("例外エラー: " + ex.Message);
            }
        }

        ////////////////////////////////////////////////////////////////////////
        // タイルの探索属性を取得
        ////////////////////////////////////////////////////////////////////////
        public AnalyzeAttributes GetAttributes()
        {
            return tile.attributes;
        }

        ////////////////////////////////////////////////////////////////////////
        // タイルの探索属性を設定
        ////////////////////////////////////////////////////////////////////////
        public void SetAttribute(AnalyzeAttributes attributes)
        {
            tile.attributes = attributes;
        }

        ////////////////////////////////////////////////////////////////////////
        // タイルの探索データ構造体を取得
        ////////////////////////////////////////////////////////////////////////
        public AnalyzeData GetAnalyzeData()
        {
            return tile.analyzeData;
        }

        ////////////////////////////////////////////////////////////////////////
        // タイルの探索データを設定
        ////////////////////////////////////////////////////////////////////////
        public void SetAnalyzeData(int cost, int heuristic_cost)
        {
            tile.analyzeData.コスト = cost;
            tile.analyzeData.推定コスト = heuristic_cost;
            tile.analyzeData.スコア = heuristic_cost + cost;
        }

        ////////////////////////////////////////////////////////////////////////
        // タイル属性を更新
        ////////////////////////////////////////////////////////////////////////
        public void UpdateTileType(TileType type)
        {
            World.UpdateTile(tile.coordinate, type);
        }

        ////////////////////////////////////////////////////////////////////////
        // オーバーロード　タイル属性を更新
        ////////////////////////////////////////////////////////////////////////
        public void UpdateTileType()
        {
            World.UpdateTile(tile.coordinate, tile.tileType);
        }

        ////////////////////////////////////////////////////////////////////////
        // タイルの探索データからスコアを取得
        ////////////////////////////////////////////////////////////////////////
        public int GetScore()
        {
            return GetAnalyzeData().スコア;
        }

        ////////////////////////////////////////////////////////////////////////
        // タイルの探索属性をOpenにする
        ////////////////////////////////////////////////////////////////////////
        public bool Open()
        {
            if(GetAttributes() != AnalyzeAttributes.IClosedTile)
            {
                SetAttribute(AnalyzeAttributes.IOpenedTile);
                return true;
            }
            return false;
        }

        ////////////////////////////////////////////////////////////////////////
        // オーバーロード　タイルがClosedでも強制的にOpenにする
        ////////////////////////////////////////////////////////////////////////
        public void Open(bool force)
        {
            if (force)
            {
                SetAttribute(AnalyzeAttributes.IOpenedTile);
            }
        }

        ////////////////////////////////////////////////////////////////////////
        // タイルの探索属性をClosedにする
        ////////////////////////////////////////////////////////////////////////
        public void Close()
        {
            if (GetAttributes() == AnalyzeAttributes.IOpenedTile)
            {
                SetAttribute(AnalyzeAttributes.IClosedTile);
            }
        }

        ////////////////////////////////////////////////////////////////////////
        // タイルが探索済みかどうかのフラグ状態を設定
        ////////////////////////////////////////////////////////////////////////
        public void SetAnalyzed(bool enable)
        {
            tile.isAnalyzed = enable;
        }

        ////////////////////////////////////////////////////////////////////////
        // タイルが探索済みかどうかのフラグを取得
        ////////////////////////////////////////////////////////////////////////
        public bool GetAnalyzed()
        {
            return tile.isAnalyzed;
        }
    }
}
